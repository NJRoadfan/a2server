#! /bin/bash
# vim: set tabstop=4 shiftwidth=4 expandtab filetype=sh:

currentVersion=125

function askYesNo()
# Ask a yes/no question of the user, with potential default
# arg1: Prompt text
# arg2: Default; 0 for yes, 1 for no, anything else for no default
# arg3: Info text for the user
# returns: 0 for yes, 1 for no
{
    local default

    case "$2" in
        0) default="y" ;;
        1) default="n" ;;
        *) default="" ;;
    esac

    if [ -n "$autoAnswerDefault" -a -n "$default" ]; then
        return $2
    fi

    if [ -n "$3" ]; then
        echo
        echo "$3"
        echo
    fi
    while :; do
        echo -n "$1 "
        [ -n "$default" ] && echo -n "[$default] "
        read
        case "$REPLY" in
            [Yy]*) return 0 ;;
            [Nn]*) return 1 ;;
            "") [ -n "$default" ] && return $2 ;;
            *) echo "Please answer yes or no." ;;
        esac
    done
}

if [[ -f /usr/local/etc/A2SERVER-version ]]; then
    installedVersion=$(cat /usr/local/etc/A2SERVER-version)
else
    installedVersion=100
fi

# Ensure URL we'll use ends in a /
case "$A2SERVER_SCRIPT_URL" in
	*/) scriptURL="$A2SERVER_SCRIPT_URL" ;;
	*) scriptURL="${A2SERVER_SCRIPT_URL:-http://appleii.ivanx.com/a2server}/" ;;
esac

autoAnswerDefault=
for arg in $@; do
    if [[ $arg == "-y" ]]; then
        autoAnswerDefault=1
        break
    fi
done

echo
echo "Update history:"
wget -qO- "${scriptURL}update/versionhistory.txt"

askYesNo "Do you want to update (or reinstall) A2SERVER?" 0 \
"installed version: ${installedVersion:0:1}.${installedVersion:1:1}.${installedVersion:2:1}
current version: ${currentVersion:0:1}.${currentVersion:1:1}.${currentVersion:2:1}"

if [ $? = 0 ]; then
    sudo rm /usr/local/etc/A2SERVER-version &> /dev/null
    # sudo rm /usr/local/etc/netatalk/a2boot/* &> /dev/null
    wget -q -O /tmp/setup "${scriptURL}setup"; source /tmp/setup "$@"
fi

unset currentVersion 2> /dev/null
unset installedVersion 2> /dev/null
