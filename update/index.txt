#! /bin/bash
# vim: set tabstop=4 shiftwidth=4 noexpandtab filetype=sh:

a2sScriptURL="https://raw.githubusercontent.com/RasppleII/a2server/master"

a2sDevel="$( dirname "${BASH_SOURCE[0]}" )/.."
if [[ -f "$a2sDevel/.a2server_source" ]]; then
	pushd $a2sDevel >/dev/null
	a2sDevel="$PWD"
	popd >/dev/null
else
	a2sDevel=
fi

# Ensure URL we'll use ends in a /
case "$A2SERVER_SCRIPT_URL" in
	*/) scriptURL="$A2SERVER_SCRIPT_URL" ;;
	*) scriptURL="${A2SERVER_SCRIPT_URL:-https://raw.githubusercontent.com/RasppleII/a2server/current}/" ;;
esac

if [[ -z "$a2sDevel" ]]; then
	currentVersion=$(wget -qO- "${scriptURL}setup/index.txt" | grep '^a2serverVersion' | cut -d '"' -f 2)
else
	currentVersion=$(grep '^a2serverVersion' "$a2sDevel/setup/index.txt" | cut -d '"' -f 2)
fi

if [[ -f /usr/local/etc/A2SERVER-version ]]; then
	read installedVersion </usr/local/etc/A2SERVER-version
    if [[ $installedVersion != *.*.* ]]; then
		# Deal with old three-digit version
        installedVersion="${installedVersion:0:1}.${installedVersion:1:1}.${installedVersion:2}"
    fi
else
	installedVersion="1.0.0"
fi

autoAnswerYes=
for arg in $@; do
	if [[ $arg == "-y" ]]; then
		autoAnswerYes=1
		break
	fi
done

echo
echo "Update history:"
if [[ -z "$a2sDevel" ]]; then
	wget -qO- "${scriptURL}update/versionhistory.txt"
else
	cat "$a2sDevel/update/versionhistory.txt"
fi
echo
echo "installed version: ${installedVersion}"
echo "current version: ${currentVersion}"
echo
if [[ $autoAnswerYes ]]; then
	REPLY="y"
else
	echo -n "Do you want to update (or reinstall) A2SERVER? "
	read
fi
if [[ ${REPLY:0:1} == "y" || ${REPLY:0:1} == "Y" ]]; then
	if [[ -z "$a2sDevel" ]]; then
		wget -q -O /tmp/setup "${scriptURL}setup/index.txt"; source /tmp/setup -i "$@"
	else
		"$a2sDevel/setup/index.txt"
	fi
fi

unset currentVersion 2> /dev/null
unset installedVersion 2> /dev/null
