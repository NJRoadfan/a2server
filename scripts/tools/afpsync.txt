#! /bin/bash
# vim: set tabstop=4 shiftwidth=4 expandtab filetype=sh:

# afpsync: updates .AppleDouble components of files on shared volumes

# this must be used if any files are copied to the shared volume via
# non-AFP methods (directly, via Samba, etc).

# usage:
# afpsync [shared volume path]
#
# -v will silently create a .volinfo file if none exists.
# If a path is specified, only that volume is synced; otherwise, all
# all paths in /srv/A2SERVER which appear in
# /usr/local/etc/netatalk/AppleVolumes.default are synced.

processPath () {
    if [[ ! -d $sharepath ]]; then
        echo "$sharepath does not exist."
    else
            IFS=''
            result=$(sudo dbd -r $sharepath | grep encoding)
            f=$(wc -l <<< $result)
            [[ $(wc -w <<< $result) == 0 ]] && f=0
            if (( f == 0 )); then
                echo "AppleDouble files have been updated for volume $sharepath."
            else
                if [[ $showerrors ]]; then
                    echo $result \
                        | while read LINE; do
                        [[ ! $(echo $LINE | grep APPLEDESKTOP) ]] && echo $LINE
                    done
                    $0 $sharepath
                else
                    echo "Use afpsync -e to see error details."
                fi
            fi
            unset IFS
    fi
}

while [[ $1 == "-e" || $1 = "-v"  ]]; do

    if [[ $1 == "-e" ]]; then
        showerrors=1
        shift
    fi
    if [[ $1 == "-v" ]]; then
        shift
    fi

done

if [[ ${1:0:1} == "-" ]]; then
    echo "Usage: afpsync [-e] [shared volume path]"
    echo
    echo "-e: show error details"
    echo "If no directory is specified, all found in"
    echo "  /usr/local/etc/netatalk/AppleVolumes.default are processed."
    echo
else
    sudo true
    if [[ $1 ]]; then
        sharepath=$(readlink -m $1)
        # behavior change in 1.3.0: now defaults to mixed case
        #   on a volume when specifying a folder and -v
        #   (as opposed to defaulting to casefold:toupper previously)
        processPath 1
    else
        crudini --get /etc/netatalk/afp.conf | grep -v Global | \
            while read line; do
            sharepath=$(crudini --get --format=sh /usr/local/etc/netatalk/afp.conf "$line" "path" | cut -d = -f 2)
            processPath
        done
    fi
fi
